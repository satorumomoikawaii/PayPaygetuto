<!DOCTYPE html>
<html>
<head>
  <title>ホーム</title>
  <meta charset="utf-8">
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <div class="main-container">
    <div class="welcome-message">
      こんにちは！
      <span class="welcome-username-vip">
        <span class="welcome-username">{{ user.username }}</span>
        <img src="/static/vip{{ user.vip_level|default(1)|int }}.png"
             alt="VIP{{ user.vip_level }}"
             class="vip-badge-inline">
      </span>
    </div>
    <div class="top-bar">
      <!-- 通知アイコン -->
      <div class="notification-icon" id="notificationButton" tabindex="0" aria-label="通知">
        <svg class="notification-bell" viewBox="0 0 40 40" fill="none">
          <path d="M20 33c2.5 0 4.5-2 4.5-4.5h-9c0 2.5 2 4.5 4.5 4.5z" fill="#1886ec"/>
          <path d="M31 28v-9c0-6-4.9-11-11-11s-11 5-11 11v9l-2 2v1h26v-1l-2-2z" stroke="#1886ec" stroke-width="2.1" fill="#fff"/>
          <path d="M11 28v-9c0-5 4.1-9 9-9s9 4 9 9v9h-18z" fill="#e3eefd"/>
        </svg>
        <span id="notificationBadge" class="notification-badge" {% if not has_unread_notification %}style="display:none;"{% endif %}></span>
      </div>
      <a href="{{ url_for('user_page') }}" class="profile-icon-simple" title="プロフィールページ" aria-label="プロフィールページ">
        <svg width="40" height="40" viewBox="0 0 40 40" fill="none">
          <circle cx="20" cy="20" r="15" stroke="#00B1E7" stroke-width="2.2"/>
          <circle cx="20" cy="16" r="4" fill="#00B1E7"/>
          <path d="M12 28c0-4.418 3.582-8 8-8s8 3.582 8 8" fill="#00B1E7"/>
        </svg>
      </a>
    </div>
    <div class="icon-select-area">
      <!-- アンケートアイコン -->
      <a href="{{ url_for('survey_list') }}" class="icon-button" title="アンケート">
        <span class="icon-image">
          <svg width="56" height="56" viewBox="0 0 56 56" fill="none">
            <rect x="12" y="10" width="32" height="38" rx="5" fill="#fff" stroke="#1886ec" stroke-width="2.2"/>
            <rect x="21" y="4.5" width="14" height="9" rx="4.5" fill="#e3eefd" stroke="#1886ec" stroke-width="2.2"/>
            <polyline points="19,22 23,26 29,18" fill="none" stroke="#00B1E7" stroke-width="2.1" stroke-linecap="round" stroke-linejoin="round"/>
            <rect x="33" y="20" width="8" height="2.6" rx="1.3" fill="#e3eefd"/>
            <polyline points="19,30 23,34 29,26" fill="none" stroke="#00B1E7" stroke-width="2.1" stroke-linecap="round" stroke-linejoin="round"/>
            <rect x="33" y="28" width="8" height="2.6" rx="1.3" fill="#e3eefd"/>
            <rect x="20" y="38" width="11" height="2" rx="1" fill="#00B1E7"/>
            <rect x="25" y="41" width="7" height="2" rx="1" fill="#00B1E7"/>
          </svg>
        </span>
        <span class="icon-label">アンケート</span>
      </a>
      <!-- アプリ案件アイコン -->
      <a href="#" class="icon-button" title="アプリ案件">
        <span class="icon-image">
          <svg width="56" height="56" viewBox="0 0 64 64" fill="none">
            <rect x="6" y="26" width="52" height="24" rx="12" fill="#e3eefd" stroke="#1886ec" stroke-width="2.5"/>
            <ellipse cx="20" cy="38" rx="4" ry="4" fill="#00B1E7"/>
            <ellipse cx="44" cy="38" rx="4" ry="4" fill="#00B1E7"/>
            <rect x="29" y="34" width="6" height="2.1" rx="1" fill="#1886ec"/>
            <rect x="31" y="36" width="2" height="6" rx="1" fill="#1886ec"/>
            <circle cx="20" cy="38" r="7" stroke="#1886ec" stroke-width="2"/>
            <circle cx="44" cy="38" r="7" stroke="#1886ec" stroke-width="2"/>
          </svg>
        </span>
        <span class="icon-label">アプリ案件</span>
      </a>
      <!-- ↓ここに追加↓ -->
      <a href="#" class="icon-button" title="コピペ案件">
        <span class="icon-image">
          <svg width="56" height="56" viewBox="0 0 56 56" fill="none">
            <rect x="12" y="10" width="32" height="38" rx="6" fill="#e3eefd" stroke="#1886ec" stroke-width="2"/>
            <rect x="19" y="17" width="18" height="24" rx="3" fill="#fff" stroke="#1886ec" stroke-width="1.2"/>
            <rect x="22" y="23" width="12" height="2.2" rx="1.1" fill="#b7d4f8"/>
            <rect x="22" y="28" width="12" height="2.2" rx="1.1" fill="#b7d4f8"/>
            <rect x="22" y="33" width="8" height="2.2" rx="1.1" fill="#b7d4f8"/>
            <rect x="22" y="38" width="8" height="2.2" rx="1.1" fill="#b7d4f8"/>
            <polyline points="28,17 28,12 36,12 36,17" fill="none" stroke="#1886ec" stroke-width="1.2"/>
          </svg>
        </span>
        <span class="icon-label">コピペ案件</span>
      </a>

      <!-- くじ引きアイコン -->
      <a href="#" class="icon-button" title="くじ引き">
        <span class="icon-image">
          <svg width="56" height="56" viewBox="0 0 56 56" fill="none">
            <ellipse cx="28" cy="28" rx="15" ry="15" fill="#fffbe6" stroke="#e3b800" stroke-width="2.5"/>
            <rect x="41" y="16" width="7" height="5" rx="2.2" fill="#e3b800" stroke="#c99c00" stroke-width="1.2"/>
            <rect x="45.5" y="13.5" width="2" height="4" rx="1" fill="#e3b800"/>
            <circle cx="28" cy="28" r="4" fill="#ffe066" stroke="#e3b800" stroke-width="1.6"/>
            <circle cx="28" cy="28" r="1.3" fill="#e3b800"/>
            <circle cx="36.5" cy="21.5" r="1.5" fill="#e3b800"/>
            <circle cx="19.5" cy="34.5" r="1.3" fill="#e3b800"/>
            <rect x="18" y="40" width="20" height="5" rx="2.5" fill="#ffe066" stroke="#e3b800" stroke-width="1.1"/>
            <circle cx="46" cy="43" r="2.5" fill="#e64a19" stroke="#b71c1c" stroke-width="1"/>
          </svg>
        </span>
        <span class="icon-label">くじ引き</span>
      </a>
    </div>
    <div class="vip-section">
      <div class="vip-header-row">
        <span class="vip-title">VIP権限</span>
        <a href="{{ url_for('vip_detail') }}" class="vip-detail-link">詳細 &gt;</a>
      </div>
      <div class="vip-badges-row">
        <button class="vip-badge selected" data-vip="0" aria-label="一般レベル">
          <img src="/static/vip1.png" alt="一般レベル" class="vip-img">
        </button>
        <button class="vip-badge" data-vip="1" aria-label="シルバーレベル">
          <img src="/static/vip2.png" alt="シルバーレベル" class="vip-img">
        </button>
        <button class="vip-badge" data-vip="2" aria-label="ゴールドレベル">
          <img src="/static/vip3.png" alt="ゴールドレベル" class="vip-img">
        </button>
        <button class="vip-badge" data-vip="3" aria-label="ダイアモンドレベル">
          <img src="/static/vip4.png" alt="ダイアモンドレベル" class="vip-img">
        </button>
      </div>
      <div class="vip-desc-area">
        <div class="vip-desc" data-vip="0" style="display:block;">
          <div class="vip-desc-title">一般レベル</div>
          <div class="vip-desc-body">
            アンケート回数：1日10回のみ<br>
            アプリ案件収益：1.0倍<br>
            くじ引き確率：通常
          </div>
        </div>
        <div class="vip-desc" data-vip="1" style="display:none;">
          <div class="vip-desc-title">シルバーレベル</div>
          <div class="vip-desc-body">
            アンケート回数：1日15回、単価100〜500円<br>
            アプリ案件収益：1.2倍<br>
            くじ引き確率：全体0.2％アップ<br>
          </div>
        </div>
        <div class="vip-desc" data-vip="2" style="display:none;">
          <div class="vip-desc-title">ゴールドレベル</div>
          <div class="vip-desc-body">
            アンケート回数：1日30回、単価500〜1500円<br>
            アプリ案件収益：1.8倍<br>
            くじ引き確率：全体0.6%アップ
          </div>
        </div>
        <div class="vip-desc" data-vip="3" style="display:none;">
          <div class="vip-desc-title">ダイアモンドレベル</div>
          <div class="vip-desc-body">
            アンケート回数：1日25回、単価3000~15000<br>
            アプリ案件収益：2倍<br>
            くじ引き確率：全体1.5%アップ
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="modalOverlay"></div>
  <div class="notification-popup" id="notificationPopup" role="dialog" aria-modal="true" aria-label="通知一覧">
    <div class="notification-popup-title-row">
      <div class="notification-popup-title">通知</div>
      <button class="notification-fullscreen-btn" id="notificationFullscreenBtn" title="全画面表示" aria-label="全画面表示">
        <svg width="22" height="22" viewBox="0 0 22 22">
          <rect x="3" y="3" width="5" height="1.8" rx="0.8" fill="#1886ec"/>
          <rect x="3" y="3" width="1.8" height="5" rx="0.8" fill="#1886ec"/>
          <rect x="13.2" y="3" width="5" height="1.8" rx="0.8" fill="#1886ec"/>
          <rect x="16.2" y="3" width="1.8" height="5" rx="0.8" fill="#1886ec"/>
          <rect x="3" y="17.2" width="5" height="1.8" rx="0.8" fill="#1886ec"/>
          <rect x="3" y="15" width="1.8" height="5" rx="0.8" fill="#1886ec"/>
          <rect x="13.2" y="17.2" width="5" height="1.8" rx="0.8" fill="#1886ec"/>
          <rect x="16.2" y="15" width="1.8" height="5" rx="0.8" fill="#1886ec"/>
        </svg>
      </button>
    </div>
    <ul class="notification-list" id="notificationList">
      <div class="notification-empty" id="notificationEmpty">通知はありません</div>
    </ul>
  </div>
  <script>
    const notifications = [
      {% for n in notifications %}
        {
          title: "{{ n.title|e }}",
          desc: "{{ n.desc|e }}",
          timestamp: "{{ n.timestamp }}",
          unread: {{ "true" if n.get('unread', False) else "false" }}
        }
        {% if not loop.last %},{% endif %}
      {% endfor %}
    ];

    function formatTimestamp(ts) {
      const date = new Date(Number(ts) * 1000);
      const mm = (date.getMonth() + 1).toString().padStart(2, '0');
      const dd = date.getDate().toString().padStart(2, '0');
      const hh = date.getHours().toString().padStart(2, '0');
      const min = date.getMinutes().toString().padStart(2, '0');
      return `${mm}/${dd} ${hh}:${min}`;
    }

    // 通知アイコンの赤丸
    const notifBadge = document.getElementById('notificationBadge');
    const notifBtn = document.getElementById('notificationButton');
    const notifPopup = document.getElementById('notificationPopup');
    const notifList = document.getElementById('notificationList');
    const notifEmpty = document.getElementById('notificationEmpty');
    const overlay = document.getElementById('modalOverlay');
    const notifFullscreenBtn = document.getElementById('notificationFullscreenBtn');
    let isNotifFullscreen = false;

    function openNotificationPopup() {
      notifPopup.classList.add('active');
      overlay.classList.add('active');
      notifList.innerHTML = '';
      if (notifications.length === 0) {
        notifEmpty.style.display = '';
        notifList.appendChild(notifEmpty);
      } else {
        notifEmpty.style.display = 'none';
        notifications.forEach(n => {
          const li = document.createElement('li');
          li.className = 'notification-item';
          li.innerHTML = `
            <div class="notification-title-row">
              <div class="notification-title">${n.title}</div>
              <div class="notification-timestamp">${formatTimestamp(n.timestamp)}</div>
            </div>
            <div class="notification-desc">${n.desc}</div>
          `;
          notifList.appendChild(li);
        });
        // 通知を全て既読に（赤丸消す）
        if (notifBadge) notifBadge.style.display = "none";
        fetch('/notification_read', {method: 'POST'});
      }
    }
    notifBtn.addEventListener('click', openNotificationPopup);

    function closeNotificationPopup() {
      notifPopup.classList.remove('active');
      notifPopup.classList.remove('fullscreen');
      isNotifFullscreen = false;
      overlay.classList.remove('active');
    }
    overlay.addEventListener('click', closeNotificationPopup);
    document.addEventListener('keydown', function(e){
      if(e.key === "Escape") closeNotificationPopup();
    });
    document.addEventListener('mousedown', function(e) {
      if (notifPopup.classList.contains('active') && !notifPopup.contains(e.target) && !notifBtn.contains(e.target)) {
        closeNotificationPopup();
      }
    });

    // 全画面ボタン
    notifFullscreenBtn.addEventListener('click', function(e){
      e.stopPropagation();
      isNotifFullscreen = !isNotifFullscreen;
      if(isNotifFullscreen){
        notifPopup.classList.add('fullscreen');
        notifFullscreenBtn.title = '元に戻す';
        notifFullscreenBtn.setAttribute('aria-label','元に戻す');
      } else {
        notifPopup.classList.remove('fullscreen');
        notifFullscreenBtn.title = '全画面表示';
        notifFullscreenBtn.setAttribute('aria-label','全画面表示');
      }
    });

    // VIPバッジ選択＆説明切り替え（これは変更なし）
    document.querySelectorAll('.vip-badge').forEach(function(btn){
      btn.addEventListener('click', function(){
        document.querySelectorAll('.vip-badge').forEach(b=>b.classList.remove('selected'));
        this.classList.add('selected');
        var vip = this.getAttribute('data-vip');
        document.querySelectorAll('.vip-desc').forEach(d=>d.style.display='none');
        var desc = document.querySelector('.vip-desc[data-vip="'+vip+'"]');
        if(desc) desc.style.display = 'block';
      });
    });
  </script>
</body>
</html>