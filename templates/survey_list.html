<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>アンケート一覧</title>
  <link rel="stylesheet" href="/static/style.css">
  <style>
    /* バナー通知スタイル：スマホアプリの通知風・ふわっと上から降りる */
    .notification-banner {
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 220px;
      max-width: 92vw;
      position: fixed;
      top: -100px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(90deg, #38c6ff 0%, #2f80ed 100%);
      color: #fff;
      font-size: 1.06em;
      font-weight: 600;
      padding: 16px 28px;
      border-radius: 16px;
      box-shadow: 0 8px 24px 0 rgba(47,128,237,0.12);
      z-index: 10000;
      opacity: 0.97;
      transition: top 0.42s cubic-bezier(.4,2,.4,1), opacity 0.35s;
      pointer-events: none;
      letter-spacing: 0.03em;
    }
    .notification-banner.show {
      top: 24px;
      opacity: 1;
      pointer-events: auto;
    }
    .notification-banner__icon {
      margin-right: 12px;
      font-size: 1.32em;
      display: flex;
      align-items: center;
    }
  </style>
</head>
<body>
  <!-- スマホバナー風通知 -->
  <div class="notification-banner" id="notification-banner">
    <span class="notification-banner__icon">🎉</span>
    <span class="notification-banner__msg"></span>
  </div>
  <div class="user-header-bar">
    <a href="{{ url_for('mypage') }}" class="user-header-back" title="ホームに戻る" aria-label="ホームに戻る">＜</a>
    <div class="user-header-title">アンケート一覧</div>
  </div>
  <div class="main-container survey-main-container">
    <h2 class="survey-title">アンケート一覧</h2>
    <div class="survey-list">
      <div class="survey-question-card" id="open-survey-modal" tabindex="0" role="button" aria-label="アンケートを開く">
        <div class="survey-question-category-row">
          <span class="survey-question-category">ユーザー調査</span>
        </div>
        <div class="survey-question-title-row">
          <span class="survey-question-title" title="もし大量にお金が貰えたら何に使いますか？">
            もし大量にお金が貰えたら何に使いますか？
          </span>
          <span class="survey-question-arrow">＞</span>
        </div>
        <div class="survey-question-reward">
          <span class="reward-icon">
            <svg width="18" height="18" viewBox="0 0 18 18">
              <circle cx="9" cy="9" r="8" fill="#fff3df" stroke="#ffb300" stroke-width="2"/>
              <circle cx="9" cy="9" r="5.5" fill="#ffe082" stroke="#ffb300" stroke-width="1.2"/>
              <text x="9" y="13.2" text-anchor="middle" font-size="9" font-weight="bold" fill="#ffb300" font-family="Arial">¥</text>
            </svg>
          </span>
          <span class="reward-label">+10円</span>
        </div>
      </div>
    </div>
  </div>

  <!-- ▼ ポップアップ・アンケートフォーム ▼ -->
  <div class="survey-modal" id="survey-modal" style="display:none;">
    <div class="survey-modal-content" id="survey-modal-content">
      <button class="survey-modal-close" id="close-survey-modal" aria-label="閉じる">&times;</button>
      <div class="survey-question-category-row" style="margin-top:10px;">
        <span class="survey-question-category">ユーザー調査</span>
      </div>
      <div class="survey-question-title-row" style="margin-bottom:10px;">
        <span class="survey-question-title" style="font-size:1.13em;" title="もし大量にお金が貰えたら何に使いますか？">
          もし大量にお金が貰えたら何に使いますか？
        </span>
      </div>
      <div class="survey-multi-note">※複数選択が可能です</div>
      <form class="survey-form">
        <fieldset class="survey-fieldset">
          <legend class="survey-legend">使い道を選んでください</legend>
          <label class="survey-option">
            <input type="checkbox" name="money_usage" value="旅行・レジャー">
            旅行・レジャー
          </label>
          <label class="survey-option">
            <input type="checkbox" name="money_usage" value="貯金・資産運用">
            貯金・資産運用
          </label>
          <label class="survey-option">
            <input type="checkbox" name="money_usage" value="家や車など高額な買い物">
            家や車など高額な買い物
          </label>
          <label class="survey-option">
            <input type="checkbox" name="money_usage" value="趣味・自己投資">
            趣味・自己投資
          </label>
          <label class="survey-option">
            <input type="checkbox" name="money_usage" value="家族や友人へのプレゼント">
            家族や友人へのプレゼント
          </label>
          <label class="survey-option">
            <input type="checkbox" name="money_usage" value="寄付・社会貢献">
            寄付・社会貢献
          </label>
          <label class="survey-option survey-option-other">
            <input type="checkbox" name="money_usage" value="その他" id="other-checkbox">
            その他
            <input type="text" name="other_usage" class="survey-other-input" placeholder="具体的に入力してください" style="display:none;">
          </label>
        </fieldset>
        <div class="form-error" style="display:none; color: red; margin-bottom:8px;"></div>
        <button type="submit" class="survey-submit-btn">回答する</button>
      </form>
    </div>
  </div>
  <!-- ▲ ポップアップここまで ▲ -->

  <script>
    // ポップアップ開閉＋アニメーション
    document.getElementById('open-survey-modal').addEventListener('click', function() {
      const modal = document.getElementById('survey-modal');
      const modalContent = document.getElementById('survey-modal-content');
      modal.style.display = 'flex';
      modalContent.classList.remove('show-anim');
      void modalContent.offsetWidth;
      modalContent.classList.add('show-anim');
    });
    document.getElementById('close-survey-modal').addEventListener('click', function() {
      document.getElementById('survey-modal').style.display = 'none';
    });

    // 「その他」チェック時にテキストボックス表示
    document.addEventListener('DOMContentLoaded', function() {
      const otherCheckbox = document.getElementById('other-checkbox');
      const otherInput = document.querySelector('.survey-other-input');
      if (otherCheckbox && otherInput) {
        otherCheckbox.addEventListener('change', function() {
          if (this.checked) {
            otherInput.style.display = 'inline-block';
            otherInput.focus();
          } else {
            otherInput.style.display = 'none';
            otherInput.value = '';
          }
        });
      }

      // 「その他」テキストボックスでエンター・確定時に5文字未満なら警告
      if (otherInput) {
        otherInput.addEventListener('keydown', function(e) {
          if (
            (e.key === 'Enter' || e.keyCode === 13) &&
            otherCheckbox.checked
          ) {
            if (!otherInput.value || otherInput.value.trim().length < 5) {
              e.preventDefault();
              showOtherInputError();
            }
          }
        });
        // モバイルでの「確定」ボタン（inputイベントで検出）
        otherInput.addEventListener('change', function(e) {
          if (otherCheckbox.checked && (!otherInput.value || otherInput.value.trim().length < 5)) {
            showOtherInputError();
          }
        });
      }

      // エラー表示関数
      function showOtherInputError() {
        const errorDiv = document.querySelector('.form-error');
        errorDiv.textContent = '「その他」の内容は最低5文字以上入力してください。';
        errorDiv.style.display = 'block';
        otherInput.focus();
      }
    });

    // ▼▼ 追加：アンケート未入力時エラー表示 ▼▼
    document.querySelector('.survey-form').addEventListener('submit', function(e) {
      const checkboxes = document.querySelectorAll('input[name="money_usage"]:checked');
      const otherCheckbox = document.getElementById('other-checkbox');
      const otherInput = document.querySelector('.survey-other-input');
      const errorDiv = document.querySelector('.form-error');
      let hasError = false;

      if (
        checkboxes.length === 0 ||
        (otherCheckbox.checked && (!otherInput.value || !otherInput.value.trim()))
      ) {
        hasError = true;
        errorDiv.textContent = '最低1つ以上選択してください。「その他」の場合は内容も入力してください。';
        errorDiv.style.display = 'block';
        e.preventDefault();
        return;
      }
      // 「その他」を選択している場合は5文字以上必須
      if (
        otherCheckbox.checked &&
        otherInput.value &&
        otherInput.value.trim().length < 5
      ) {
        errorDiv.textContent = '「その他」の内容は最低5文字以上入力してください。';
        errorDiv.style.display = 'block';
        e.preventDefault();
        otherInput.focus();
        return;
      }

      errorDiv.style.display = 'none';

      // ▼▼ アンケート送信時、通知バナー表示＋2秒後に一覧へ戻る ▼▼
      e.preventDefault(); // テスト用：本番はアンケート送信処理後にリダイレクトする
      showNotificationBanner("アンケートに回答しました！");
      setTimeout(() => {
        // 一覧ページへリダイレクト（今いるページを再読み込みならlocation.reload()でもOK）
        window.location.href = window.location.pathname; // そのまま一覧に戻す
      }, 2000);
    });
    // ▲▲ 追加ここまで ▲▲

    // ▼▼ 通知バナー表示関数 ▼▼
    function showNotificationBanner(message) {
      const banner = document.getElementById('notification-banner');
      const barMsg = banner.querySelector('.notification-banner__msg');
      barMsg.textContent = message;
      banner.classList.add('show');
      setTimeout(() => {
        banner.classList.remove('show');
      }, 1800); // 2秒以内で消してリダイレクト
    }
    // ▲▲ 通知バナーここまで ▲▲

  </script>
</body>
</html>